---
title: Troubleshooting AD FS
ms.custom: na
ms.reviewer: na
ms.suite: na
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 410013ab-d2f0-4901-aa06-ca4ef84a907e
---
# Troubleshooting AD FS
<?xml version="1.0" encoding="utf-8"?>
<developerConceptualDocument xmlns="http://ddue.schemas.microsoft.com/authoring/2003/5" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://ddue.schemas.microsoft.com/authoring/2003/5 http://dduestorage.blob.core.windows.net/ddueschema/developer.xsd">
  <introduction>
    <para>This topic describes how to prepare and configure computers in order to troubleshoot Active Directory Federation Services (AD FS) and provides links to other topics that describe how to troubleshoot specific AD FS issues. </para>
  </introduction>
  <section>
    <title>Preparation tasks for diagnosing AD FS issues</title>
    <content>
      <para>To configure your computers in preparation for diagnosing AD FS-related issues, you should perform the following tasks:</para>
      <list class="bullet">
        <listItem>
          <para>
            <link xlink:href="410013ab-d2f0-4901-aa06-ca4ef84a907e#bkmk_SetupAdfsEventLogging">Set up AD FS event logging</link>
          </para>
        </listItem>
        <listItem>
          <para>
            <link xlink:href="410013ab-d2f0-4901-aa06-ca4ef84a907e#bkmk_ConfigureDebugTracing">Configure debug tracing for AD FS</link>
          </para>
        </listItem>
        <listItem>
          <para>
            <link xlink:href="410013ab-d2f0-4901-aa06-ca4ef84a907e#bkmk_ConfigureAuditing">Configure auditing for AD FS</link>
          </para>
        </listItem>
        <listItem>
          <para>
            <link xlink:href="410013ab-d2f0-4901-aa06-ca4ef84a907e#bkmk_ConfigurePerfMon">Configure performance monitoring for AD FS</link>
          </para>
        </listItem>
      </list>
    </content>
    <sections>
      <section address="bkmk_SetupAdfsEventLogging">
        <title>Set up AD FS event logging</title>
        <content>
          <para>Before you change the configuration for troubleshooting AD FS, use Event Viewer to verify that AD FS–related events appear in application logs. By default, AD FS uses a verbose level of logging that includes logging of all errors, warnings, and informational events. To ensure that you use event logging to diagnose a problem, you can verify or reconfigure the AD FS log level by using Event Viewer. You can also use <token>wps_Token> for AD FS for command-line management  by using the <system>LogLevel</system> parameter in the <system>Set-ADFSProperties</system> cmdlet, or by using the AD FS Management snap-in. In the AD FS Management snap-in, click <ui>Edit federation service properties</ui>, and then select the check boxes for event log levels.</para>
          <procedure>
            <title>To filter for any AD FS-related events</title>
            <steps class="ordered">
              <step>
                <content>
                  <para>Open the Event Viewer snap-in.</para>
                  <para>To open Event Viewer, on the <ui>Start</ui> screen, type<?Comment SE(L: The token starts with a capital letter in &quot;on&quot; which does not work in the middle of a sentence. 2013-11-07T15:44:00Z  Id='59?><?CommentEnd Id='59'
    ?> <ui>Event Viewer</ui>.</para>
                </content>
              </step>
              <step>
                <content>
                  <para>In the console tree, expand <ui>Applications and Services Logs</ui>, expand <ui>AD FS</ui>, and then click <ui>Admin</ui>.</para>
                </content>
              </step>
              <step>
                <content>
                  <para>In the <ui>Filter Current Log</ui> dialog box, for <ui>Event level</ui>, verify that the following check boxes are selected for these levels of events: <ui>Warning</ui>, <ui>Information</ui>, and <ui>Error</ui>. Click <ui>OK</ui>.</para>
                  <para>
                    <?Comment SE(L: Suggestion: &quot;In the Details pane, you can set a filter that shows all events….&quot; 2013-11-08T16:07:00Z  Id='63?>The Details pane is filtered to show <?CommentEnd Id='63'
    ?>all events that might be problems or support issues that are related to AD FS.</para>
                </content>
              </step>
            </steps>
          </procedure>
          <para>At this point, you should focus on reviewing any events that appear in the filtered log. These events might indicate a potential service-level issue. In some instances, you might want to use the <system>Get-ADFSProperties</system> cmdlet to verify the current <system>LogLevel</system> setting. </para>
          <alert class="note">
            <para>Some of the error descriptions that appear in exception details might not apply to AD FS, but are generated by other external sources, such as by <token>firstref_idfToken>. </para>
          </alert>
          <para>Verbose logging allows for full, unfiltered logging of all errors and warnings, which depends on the configuration choices that you made in your deployment. The small subset of events that verbose logging adds should not affect normal operations. However, they can be used in situations in which you are troubleshooting service issues. If for any reason verbose logging is reset to streamline logging, you can use the following command to reset event logging to the verbose installation default setting.</para>
          <code>Set-ADFSProperties  -LogLevel Verbose,Errors,Warnings,Information</code>
          <alert class="note">
            <para>To configure verbose logging, you can only use the <system>Set-ADFSProperties</system> cmdlet as provided as part of the <token>wps_Token> cmdlets for AD FS. You cannot modify this aspect of the event log profile by using the AD FS Management snap-in.</para>
          </alert>
        </content>
      </section>
      <section address="bkmk_ConfigureDebugTracing">
        <title>Configure debug tracing for AD FS</title>
        <content>
          <para>When you enable debug tracing, you make an extended set of events available that can help you troubleshoot issues. AD FS uses the Event Tracing for Windows (ETW) framework to log traces.</para>
          <para>To enable debug tracing, use Event Viewer and configure it to log events that have the AD FS Tracing event source. Unlike the AD FS event log, the AD FS trace log is not enabled by default because hundreds of trace log entries can be logged each time that the Federation Service processes a request.</para>
          <para>By default, the trace log file size is configured to be 10 gigabytes (GB) in size, and the log is not circular, which means it recycles and overwrites older log file data with more recent log data. To change trace log file properties, right-click the <ui>AD FS Tracing\Debug</ui> node, and then click the <ui>Properties</ui> option in Event Viewer.</para>
          <alert class="note">
            <para>If you enable circular logging with AD FS trace logging, you first must stop trace logging before you can view trace log details.</para>
          </alert>
          <para>To enable verbose trace logging, stop AD FS trace logging, run the following Wevutil.exe executable program at the command prompt, and then restart AD FS trace logging.</para>
          <code>wevtutil sl "AD FS Tracing/Debug" /l:5</code>
          <para>For more information about enabling debug tracing, see <externalLink><linkText>Enable Debug Tracing</linkText><linkUri><?Comment SE(L: http://winedit:FWLinks:Change your URL from a 302 redirect (temporary) to a 301 redirect (permanent), by adding /p/ between “FWLink” and “?LinkID.” 2013-11-07T14:47:00Z  Id='142?>http://go.microsoft.com/fwlink/p/?LinkId=182388<?CommentEnd Id='142'
    ?></linkUri></externalLink> <?Comment SE(L: http://winedit: FWLinks: The new FWLink guidelines do not recommend using the URL after the linked document as a visible URL. Please follow your group's preference on this. 2013-11-07T14:47:00Z  Id='144?>(http://go.microsoft.com/fwlink/p/?LinkId=182388).<?CommentEnd Id='144'
    ?></para>
        </content>
        <sections>
          <section>
            <title>WCF and WIF trace messages</title>
            <content>
              <para>
                <?Comment SE(L: Are there specific reasons why it might be necessary, other than that WCF and WIF can be logged, such as a specific problem in Active Directory? If there are, please replace &quot;Sometimes&quot; with those specific times. 2013-11-07T16:31:00Z  Id='146?>Sometimes it might be necessary to review Windows Communication Foundation (WCF) and Windows Identity Foundation (WIF) trace messages to troubleshoot an issue. <?CommentEnd Id='146'
    ?>AD FS makes it possible for WCF and WIF traces to be logged in the AD FS trace log along with AD FS traces. To enable WCF and WIF tracing, you have to modify the <embeddedLabel>Microsoft.IdentityServer.ServiceHost.Exe.Config</embeddedLabel> file. To enable WCF and WIF trace messages, modify the corresponding trace sources as shown in the following example by setting the appropriate value for the <embeddedLabel>switchValue</embeddedLabel> attribute. After you apply these changes, save the configuration, and then restart the AD FS Windows service to start WCF and WIF trace messages in the AD FS trace log.</para>
              <code>&lt;system.diagnostics&gt;
&lt;sources&gt;
&lt;!-- To enable WIF tracing, change the switchValue below to <?Comment SE(L: &quot;desired&quot;:MSTP: do not use &quot;desired&quot;. Write around it: &quot;the following&quot;. 2013-11-08T15:46:00Z  Id='172?>desired<?CommentEnd Id='172'
    ?> trace level - Verbose, Information, Warning, Error, Critical --&gt;
<codeFeaturedElement>&lt;source name="Microsoft.IdentityModel" switchValue="Off"&gt;</codeFeaturedElement> … &lt;/source&gt;
&lt;!-- To enable WCF tracing, change the switchValue below to desired trace level - Verbose, Information, Warning, Error, Critical --&gt;
<codeFeaturedElement>&lt;source name="System.ServiceModel" switchValue="Off" &gt;</codeFeaturedElement> … &lt;/source&gt;
&lt;/sources&gt;
&lt;/system.diagnostics&gt;</code>
              <para>When you enable the traces by setting the appropriate switches, WIF traces appear in the AD FS trace log under the keyword <system>ADFSWIF</system>, and WCF traces appear in the trace log under the keyword <system>ADFSWCF</system>.</para>
            </content>
          </section>
          <section>
            <title>Correlating AD FS events and traces by using Activity ID and Caller ID</title>
            <content>
              <para>When an error occurs during processing of a single token-issuance request by the Federation Service, multiple errors might be logged by AD FS and the <?Comment SE(L: Please clarify &quot;federation passive&quot;.One explanation: WS-Federation Passive Requestor Profileis aWeb Servicesspecification - intended to work with theWS-Federationspecification - which defines how identity, authentication and authorization mechanisms work across trust realms. The specification deals specifically with how applications, such as web browsers, make requests using these mechanisms. In this context, the web-browser is known as a &quot;passive requestor.&quot; 2013-11-08T15:49:00Z  Id='180?>federation passive Web application <?CommentEnd Id='180'
    ?>in the event log. In addition, there can be multiple errors logged that correspond to different token-issuance requests by different users. For these reasons, analyzing a particular request failure might be difficult because of the volume of events that can be present in the logs.</para>
              <para>To assist in correlating AD FS events in the event log that correspond to a particular request, the Federation Service generates an Activity ID, which is a globally unique identifier (GUID) that maps WCF and WIF events and trace messages to each specific token-issuance request that is processed. The Activity ID is logged as part of every event that AD FS logs or traces. You can use the Activity ID to filter messages in the event log to help isolate and examine all events that correspond to a specific token-issuance request. </para>
              <alert class="tip">
                <para>To correlate Activity IDs between AD FS event log entries and AD FS trace log entries, match the value of the <embeddedLabel>ActivityID</embeddedLabel> attribute for the <system>&lt;Correlation&gt;</system> element in the event XML details. In Event Viewer, to locate this attribute value, click the <ui>Details</ui> tab to view a specific event, and then click the <ui>XML view</ui> option.</para>
              </alert>
            </content>
          </section>
          <section>
            <title>Debugging token issuance request failures using the Caller ID event</title>
            <content>
              <para>When you can locate the <embeddedLabel>ActivityID</embeddedLabel> attribute for cross-referencing AD FS events with AD FS trace log entries, you can use this attribute to debug token-issuance request failures for the Federation Service. The critical link for this reference is the Caller ID event, a special event that is logged during token-issuance failures in the AD FS event log as a warning and with Event ID 1000. This event contains the claim type and value of the claim type, if it is available in the caller identity information that is passed to the Federation Service as part of a token request.</para>
              <para>Note that the Caller ID event also has <embeddedLabel>ActivityID</embeddedLabel> logged, as described in the previous tip. By searching for specific claim values that correspond to the claim types, you can locate the Activity ID in the Caller ID event and use that Activity ID to filter or search the event log and trace log that correspond to all the events and traces for that request. </para>
              <para>As an alternative, there is another way to obtain the Activity ID from users when a token issuance occurs in a browser-based application scenario. When a <?Comment SE(L: Suggestion: In case a reader does not know the definition of &quot;passive client&quot; as &quot;A Web browser that interacts with a claims-based application running on an HTTP server&quot; or this definition might not be how you intended it here, could you please clarify this term. 2013-11-07T15:40:00Z  Id='219?>passive client <?CommentEnd Id='219'
    ?>Web application shows a generic error page with the error message for the failed token request, it also displays the Activity ID that corresponds to the failure as part of <ui>Additional data</ui>. The user who sees the error in the browser can send the Activity ID to support personnel. The support personnel then uses this value to search the AD FS event and AD FS trace logs and locates all error events and traces, if tracing is enabled, that correspond to the failed token-issuance request.</para>
            </content>
          </section>
          <section>
            <title>Filtering AD FS events</title>
            <content>
              <para>You can use the following procedures to search and filter AD FS event and trace log entries. </para>
              <procedure>
                <title>To search and find an Activity ID in AD FS events</title>
                <steps class="ordered">
                  <step>
                    <content>
                      <para>Open Event Viewer.</para>
                      <para>To open Event Viewer, on the <ui>Start</ui> screen, type <ui>Event Viewer</ui>.</para>
                    </content>
                  </step>
                  <step>
                    <content>
                      <para>In the console tree, expand <ui>Applications and Services Logs</ui>, expand <ui>AD FS</ui>, and then click <ui>AD FS/Admin</ui>.</para>
                    </content>
                  </step>
                  <step>
                    <content>
                      <para>On the <ui>Action</ui> menu, click <ui>Find</ui>, enter the Activity ID that you are looking for, and then click <ui>Find Next</ui> to locate and view each event that is associated with the Activity ID that you entered.</para>
                    </content>
                  </step>
                </steps>
              </procedure>
              <alert class="note">
                <para>If debug tracing has been enabled previously, repeat this procedure on the Trace Log node. To locate the trace events for AD FS, in the console tree, expand <ui>Applications and Services Logs</ui>, expand <ui>AD FS Tracing</ui>, and then click <ui>Debug</ui>.</para>
              </alert>
              <procedure>
                <title>To filter the AD FS logs to display only events or traces that match a specific Activity ID</title>
                <steps class="ordered">
                  <step>
                    <content>
                      <para>Open Event Viewer.</para>
                      <para>To open Event Viewer, on the <ui>Start</ui> screen, type <ui>Event Viewer</ui>.</para>
                    </content>
                  </step>
                  <step>
                    <content>
                      <para>In the console tree, expand <ui>Applications and Services Logs</ui>, expand <ui>AD FS</ui>, and then click <ui>AD FS/Admin</ui>.</para>
                    </content>
                  </step>
                  <step>
                    <content>
                      <para>On the <ui>Action</ui> menu, click <ui>Filter Current Log</ui>.</para>
                    </content>
                  </step>
                  <step>
                    <content>
                      <para>Click the <ui>XML</ui> tab, and then select the <ui>Edit query manually</ui> check box.</para>
                    </content>
                  </step>
                  <step>
                    <content>
                      <para>Click <ui>Yes</ui> when you are prompted to confirm manual editing of the query.</para>
                    </content>
                  </step>
                  <step>
                    <content>
                      <para>Update the query as shown in the following example to include the <embeddedLabel>ActivityID</embeddedLabel> attribute to set as the scope of the log filter. Modify <embeddedLabel>ActivityID</embeddedLabel> in the example with the exact value of <embeddedLabel>ActivityID</embeddedLabel> from your deployment, and then click <ui>OK</ui>.</para>
                      <code>&lt;QueryList&gt;
  &lt;Query Id="0" Path="AD FS Eventing/Admin"&gt;
    &lt;Select Path=" AD FS/Admin "&gt;*<codeFeaturedElement>[System[Correlation[@ActivityID='{77269359-0b7d-45cb-9760-e3a4009883d9}']]]</codeFeaturedElement>&lt;/Select&gt;
  &lt;/Query&gt;
&lt;/QueryList&gt;
</code>
                    </content>
                  </step>
                </steps>
              </procedure>
            </content>
          </section>
        </sections>
      </section>
      <section address="bkmk_ConfigureAuditing">
        <title>Configure auditing for AD FS</title>
        <content>
          <para>To enable auditing for AD FS might be beneficial in situations in which you place a high value on the security of your identity deployment and prefer to monitor it closely for suspicious or unintended activity. The value of auditing might be balanced by the increased time that you spend reviewing or managing the additional event log detail that auditing can generate in your deployment. </para>
          <para>The process of enabling auditing for AD FS requires changes that you make by using the Local Security Policy snap-in for your federation server and changes in the Service properties that you set by using the AD FS Management snap-in.</para>
          <procedure>
            <title>To enable auditing for AD FS</title>
            <steps class="ordered">
              <step>
                <content>
                  <para>
                    <token>clickstarToken> <ui>Local Security Policy</ui>.</para>
                </content>
              </step>
              <step>
                <content>
                  <para>Navigate to the <ui>Security Settings\Local Policies\User Rights Management</ui> folder, and then double-click <ui>Generate security audits</ui>.</para>
                </content>
              </step>
              <step>
                <content>
                  <para>On the <ui>Local Security Setting</ui> tab, verify that the <token>ad_adds_Token> service account is listed. If it is not present, click <ui>Add User or Group</ui> and add it to the list, and then click <ui>OK</ui>.</para>
                </content>
              </step>
              <step>
                <content>
                  <para>Open a command prompt with elevated privileges and run the following command to enable auditing.</para>
                  <code>auditpol.exe /set /subcategory:"Application Generated" /failure:enable /success:enable</code>
                </content>
              </step>
              <step>
                <content>
                  <para>Close <ui>Local Security Policy</ui>, and then open the AD FS Management snap-in.</para>
                </content>
              </step>
              <step>
                <content>
                  <para>In the <ui>Actions</ui> pane, click <ui>Edit Federation Service Properties</ui>.</para>
                </content>
              </step>
              <step>
                <content>
                  <para>In the <ui>Federation Service Properties</ui> dialog box, click the <ui>Events</ui> tab.</para>
                </content>
              </step>
              <step>
                <content>
                  <para>Select the <ui>Success audits</ui> and the <ui>Failure audits</ui> check boxes.</para>
                </content>
              </step>
              <step>
                <content>
                  <para>Click <ui>OK</ui>.</para>
                </content>
              </step>
            </steps>
          </procedure>
          <alert class="note">
            <para>To modify settings on domain-level <?Comment SE(L: Per Group Policy style sheet,http://winedit, upper case. 2013-11-07T14:47:00Z  Id='295?>Group Policy Objects <?CommentEnd Id='295'
    ?>could possibly override these auditing settings.</para>
          </alert>
          <procedure>
            <title>To disable auditing AD FS</title>
            <steps class="bullet">
              <step>
                <content>
                  <para>Open a command prompt with elevated privileges and run the following command to enable auditing.</para>
                  <code>auditpol.exe /set /subcategory:"Application Generated" /failure:disable /success:disable</code>
                </content>
              </step>
            </steps>
          </procedure>
          <procedure>
            <title>To verify the status for AD FS auditing</title>
            <steps class="bullet">
              <step>
                <content>
                  <para>To verify the current status of auditing for AD FS, you can run the following command.</para>
                  <code>auditpol.exe /get /subcategory:"Application Generated" /r</code>
                </content>
              </step>
            </steps>
          </procedure>
        </content>
      </section>
      <section address="bkmk_ConfigurePerfMon">
        <title>Configure performance monitoring for AD FS</title>
        <content>
          <para>AD FS includes its own dedicated performance counters. To use the Windows Reliability and Performance Monitor to monitor the performance of your AD FS servers, you can create a new data collector set and add the AD FS counters to that view. For more information about setting up performance monitoring for AD FS, see the <legacyLink xlink:href="a987c9e5-910e-410f-a780-4c9630fe2809">Windows Server 2012 AD FS Deployment Guide</legacyLink>.</para>
        </content>
      </section>
    </sections>
  </section>
  <section>
    <title>Troubleshooting specific AD FS problems</title>
    <content>
      <para>The following topics cover events that are related to specific AD FS problems, including the Event ID or other symptoms, possible causes, and resolutions. </para>
      <list class="bullet">
        <listItem>
          <para>
            <externalLink>
              <linkText>Troubleshooting Federation Service startup and shutdown problems</linkText>
              <linkUri>http://technet.microsoft.com/library/adfs2-troubleshooting-federation-service-startup-and-shutdown-problems(v=ws.10).aspx</linkUri>
            </externalLink>
          </para>
        </listItem>
        <listItem>
          <para>
            <externalLink>
              <linkText>Troubleshooting configuration failures</linkText>
              <linkUri>http://technet.microsoft.com/library/adfs2-troubleshooting-configuration-failures(v=ws.10).aspx</linkUri>
            </externalLink>
          </para>
        </listItem>
        <listItem>
          <para>
            <externalLink>
              <linkText>Troubleshooting audit failures</linkText>
              <linkUri>http://technet.microsoft.com/library/adfs2-troubleshooting-audit-failures(v=ws.10).aspx</linkUri>
            </externalLink>
          </para>
        </listItem>
        <listItem>
          <para>
            <externalLink>
              <linkText>Troubleshooting certificate problems</linkText>
              <linkUri>http://technet.microsoft.com/library/adfs2-troubleshooting-certificate-problems(v=ws.10).aspx</linkUri>
            </externalLink>
          </para>
        </listItem>
        <listItem>
          <para>
            <externalLink>
              <linkText>Troubleshooting trust management problems</linkText>
              <linkUri>http://technet.microsoft.com/library/adfs2-troubleshooting-trust-management-problems(v=ws.10).aspx</linkUri>
            </externalLink>
          </para>
        </listItem>
        <listItem>
          <para>
            <externalLink>
              <linkText>Troubleshooting token issuance problems</linkText>
              <linkUri>http://technet.microsoft.com/library/adfs2-troubleshooting-token-issuance-problems(v=ws.10).aspx</linkUri>
            </externalLink>
          </para>
        </listItem>
        <listItem>
          <para>
            <externalLink>
              <linkText>Troubleshooting token acceptance problems</linkText>
              <linkUri>http://technet.microsoft.com/library/ff641740(v=ws.10).aspx</linkUri>
            </externalLink>
          </para>
        </listItem>
        <listItem>
          <para>
            <externalLink>
              <linkText>Troubleshooting certificate management problems</linkText>
              <linkUri>http://technet.microsoft.com/library/adfs2-troubleshooting-certificate-management-problems(v=ws.10).aspx</linkUri>
            </externalLink>
          </para>
        </listItem>
        <listItem>
          <para>
            <externalLink>
              <linkText>Troubleshooting federation server farm problems</linkText>
              <linkUri>http://technet.microsoft.com/library/adfs2-troubleshooting-federation-server-farm-problems(v=ws.10).aspx</linkUri>
            </externalLink>
          </para>
        </listItem>
      </list>
    </content>
  </section>
  <relatedTopics />
</developerConceptualDocument>

